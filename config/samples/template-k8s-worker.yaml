apiVersion: stargate.io/v1alpha1
kind: Template
metadata:
  name: k8s-worker
  namespace: dc-simulator
spec:
  osVersion: "ubuntu-22.04"
  osImage: "https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img"
  cloudInit: |
    #cloud-config
    # Kubernetes Worker Node Cloud-Init Template
    # This template provisions a VM to join a Kubernetes cluster as a worker node
    
    hostname: ${HOSTNAME}
    
    users:
      - name: ubuntu
        sudo: ALL=(ALL) NOPASSWD:ALL
        shell: /bin/bash
        lock_passwd: false
        # Set password to 'ubuntu' for debugging (remove in production)
        passwd: $6$rounds=4096$xyz$ghXR9MZwJ.cFV0X6UKzgP7.5XL0zzN3pDjjYtDJVxNVRUb7wkKjMSfLqHEP9mW.8nZ.EqS2kPwXpBvJSJL9rl/
    
    package_update: true
    package_upgrade: true
    
    packages:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - socat
      - conntrack
      - ipset
    
    write_files:
      - path: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
      
      - path: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1
      
      - path: /etc/crictl.yaml
        content: |
          runtime-endpoint: unix:///run/containerd/containerd.sock
          image-endpoint: unix:///run/containerd/containerd.sock
          timeout: 10
      
      - path: /tmp/install-k8s.sh
        permissions: '0755'
        content: |
          #!/bin/bash
          set -ex
          
          echo "=== Starting Kubernetes worker setup ==="
          
          # Load kernel modules
          modprobe overlay
          modprobe br_netfilter
          sysctl --system
          
          # Disable swap
          swapoff -a
          sed -i '/swap/d' /etc/fstab
          
          # Install containerd
          mkdir -p /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
          apt-get update
          apt-get install -y containerd.io
          
          # Configure containerd for Kubernetes
          mkdir -p /etc/containerd
          containerd config default > /etc/containerd/config.toml
          sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
          systemctl restart containerd
          systemctl enable containerd
          
          # Install Kubernetes components (v1.29)
          curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
          echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' > /etc/apt/sources.list.d/kubernetes.list
          apt-get update
          apt-get install -y kubelet kubeadm kubectl
          apt-mark hold kubelet kubeadm kubectl
          
          echo "=== Kubernetes components installed ==="
          
          # The join command should be provided via the template when generated
          # Example: kubeadm join <host-ip>:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>
          if [[ -f /tmp/kubeadm-join.sh ]]; then
            echo "=== Joining Kubernetes cluster ==="
            bash /tmp/kubeadm-join.sh
          else
            echo "=== No join command found, skipping cluster join ==="
          fi
          
          echo "=== Kubernetes worker setup complete ==="
    
    runcmd:
      - /tmp/install-k8s.sh
    
    final_message: "Kubernetes worker node setup complete after $UPTIME seconds"
